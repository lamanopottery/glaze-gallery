---
import { isLoggedIn, redirectToLogin } from "@/utils";

if (!(await isLoggedIn(Astro))) {
  return redirectToLogin(Astro);
}

const { GLAZE_GALLERY_BUCKET, GLAZE_GALLERY_STUDIO_DIR } = Astro.locals.runtime.env;
const { glaze1, glaze2, side, res } = Astro.params;

const file = await GLAZE_GALLERY_BUCKET.get(
  `${GLAZE_GALLERY_STUDIO_DIR}/${glaze1}-${glaze2}-${side}-${res}.webp`,
);

if (Astro.request.headers.get("If-None-Match") === file?.httpEtag) {
  return new Response(null, { status: 304 });
}

if (file) {
  const contentType = file.httpMetadata?.contentType ?? "image/webp";
  return new Response(file.body, {
    headers: {
      "Content-Type": contentType,
      ETag: file.httpEtag,
    },
  });
}

return new Response(null, { status: 404 });
---
